version: 2.1

orbs:
  python: circleci/python@2.0.3
  aws-cli: circleci/aws-cli@1.2.1
  aws-s3: circleci/aws-s3@2.0

parameters:
  python-ci-image:
    type: string
    default: "858290205983.dkr.ecr.eu-west-2.amazonaws.com/circleci-devs:latest"

jobs:
  check-product-availability-unit-test:
    docker:
      - image: << pipeline.parameters.python-ci-image >>
      - image: circleci/mongo:4.4.12
    working_directory: ~/project/lambdas/check_product_availability
    steps:
      - run-unit-tests

  pay-order-unit-test:
    docker:
      - image: << pipeline.parameters.python-ci-image >>
      - image: circleci/mongo:4.4.12
    working_directory: ~/project/lambdas/pay-order
    steps:
      - run-unit-tests

workflows:
  main:
    jobs:
      - check-product-availability-unit-test
      - pay-order-unit-test


commands:

  setup-dev-dependencies:
    description: "Install poetry dependencies with dev"
    steps:
      - python/install-packages:
          args: '--with dev'
          pkg-manager: poetry
          pypi-cache: false
          venv-cache: false

  run-unit-tests:
    description: "Install poetry dependencies and run unit test"
    steps:
      - checkout:
          path: ~/project
      - setup-dev-dependencies
      - run:
          name: Run tests
          command: poetry run pytest test --junit-xml=tests.xml
      - store_test_results:
          path: tests.xml